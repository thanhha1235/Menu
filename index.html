<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Báo Cáo Suất Ăn Thông Minh</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons (optional, for button icons) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#34495e">
    <style>
        /* Animation for fade-in */
        .fade-in {
            animation: fadeIn 0.7s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px);}
            to { opacity: 1; transform: none;}
        }
        /* Button hover effect */
        .btn-animate:active {
            transform: scale(0.97);
            opacity: 0.85;
        }
        /* Table row hover */
        .table-hover tbody tr:hover td {
            background-color: #eaf6ff !important;
            transition: background 0.2s;
        }
        /* Custom highlight for total row */
        .table tfoot tr td, .table .total-cell {
            background: #fff3cd !important;
            color: #856404 !important;
            font-weight: bold;
        }
        /* Responsive table wrapper */
        .table-responsive {
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            background: #fff;
        }
        /* Custom for sticky first column on mobile */
        @media (max-width: 600px) {
            .table th:first-child, .table td:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background: #f8f9fa;
            }
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-4 fade-in">
    <div class="row justify-content-center mb-3">
        <div class="col-lg-8 text-center">
            <h2 class="fw-bold text-primary mb-2">Công Cụ Tổng Hợp Suất Ăn</h2>
            <div class="alert alert-info shadow-sm py-2 mb-3 fade-in" role="alert">
                <strong>Mẹo nhập liệu nhanh:</strong><br>
                - Dòng nào <strong>không có số</strong> sẽ được hiểu là tên <strong>Khối</strong> <br>
                - Dòng nào <strong>có số ở cuối</strong> sẽ được hiểu là <strong>Thực đơn + Số lượng</strong>
            </div>
        </div>
    </div>
    <div class="row g-3 align-items-start mb-3">
        <div class="col-lg-8 position-relative">
            <textarea id="inputText" class="form-control shadow-sm" rows="7" placeholder="Dán báo cáo vào đây. Ví dụ:

VPNH
TD1 8
TD2 4

Khối KHCN
Thực đơn 1: 5
Thực đơn 3 - 2 suất"></textarea>
            <button type="button"
                class="btn btn-secondary btn-sm position-absolute top-0 end-0 m-2 btn-animate"
                style="z-index:2;"
                onclick="pasteFromClipboard()">
                <i class="bi bi-clipboard"></i> Dán nhanh
            </button>
        </div>
        <div class="col-lg-4 d-flex flex-lg-column flex-row gap-2">
            <button class="btn btn-success btn-lg btn-animate shadow-sm flex-fill" onclick="processData()">
                <i class="bi bi-arrow-down-circle"></i> Cập nhật vào bảng
            </button>
            <button class="btn btn-primary btn-lg btn-animate shadow-sm flex-fill" onclick="exportTableAsImage()">
                <i class="bi bi-image"></i> Lưu ảnh bảng
            </button>
            <button class="btn btn-danger btn-lg btn-animate shadow-sm flex-fill" onclick="resetData()">
                <i class="bi bi-arrow-clockwise"></i> Xóa làm lại
            </button>
        </div>
    </div>
    <div class="table-responsive shadow-sm fade-in mb-3" id="tableExportWrapper">
        <table id="mainTable" class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-dark"></thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="text-center">
        <button id="btnInstall" class="btn btn-success btn-lg btn-animate mt-2" style="display:none;">
            <i class="bi bi-plus-circle"></i> Thêm vào Màn hình chính
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
    let database = {}; // Cấu trúc: { "Tên Khối": { "Tên Món": Số lượng } }
    let allDishes = new Set(); // Lưu danh sách các món ăn duy nhất

    function saveToLocal() {
        try {
            localStorage.setItem('setmenu_db', JSON.stringify(database));
            localStorage.setItem('setmenu_dishes', JSON.stringify(Array.from(allDishes)));
        } catch (e) {
            console.warn('Lưu localStorage thất bại', e);
        }
    }

    function loadFromLocal() {
        try {
            const db = localStorage.getItem('setmenu_db');
            const dishes = localStorage.getItem('setmenu_dishes');
            if (db) database = JSON.parse(db);
            if (dishes) allDishes = new Set(JSON.parse(dishes));
            renderTable();
        } catch (e) {
            console.warn('Khôi phục localStorage thất bại', e);
        }
    }

    function processData() {
        const text = document.getElementById('inputText').value;
        const lines = text.split('\n');
        let currentBlock = "Chưa xác định"; // Tên khối mặc định nếu dòng đầu tiên là món ăn

        lines.forEach(line => {
            line = line.trim();
            if (!line) return; // Bỏ qua dòng trống

            // LOGIC NHẬN DIỆN THÔNG MINH
            // Regex mới: nhận tên món và số lượng ở cuối, có thể có dấu :, -, hoặc chữ suất/pax/s phía sau
            let match = line.match(/^(.*?)(?:[\s:\-=]+)?(\d+)\s*(?:suất|suat|pax|s)?\.?$/i);

            if (match) {
                // === ĐÂY LÀ DÒNG THỰC ĐƠN ===
                let dishName = match[1].trim();
                let quantity = parseInt(match[2]);

                // Làm sạch tên món (Bỏ dấu : hoặc - thừa ở cuối tên món nếu regex chưa bắt hết)
                dishName = dishName.replace(/[:\-=]+$/, '').trim();

                // Chuẩn hóa tên món (Viết hoa chữ cái đầu để đẹp bảng)
                if(dishName.toLowerCase().startsWith('thực đơn')) dishName = capitalizeFirstLetter(dishName);
                if(dishName.toLowerCase().startsWith('td')) dishName = dishName.replace(/td/i, 'Thực đơn');

                if (dishName && quantity > 0) {
                    if (!database[currentBlock]) database[currentBlock] = {};
                    // Ghi đè số lượng thay vì cộng dồn
                    database[currentBlock][dishName] = quantity;
                    allDishes.add(dishName);
                }

            } else {
                let blockName = line.replace(/^(Khối|Khoi|Phòng|Ban|Team)\s*[:\.]?/i, '').replace(/[:\.]+$/, '').trim();
                if (blockName.length > 0) {
                    currentBlock = blockName;
                    // Khởi tạo object cho khối này để đảm bảo nó hiện lên cột ngay cả khi chưa có món
                    if (!database[currentBlock]) database[currentBlock] = {};
                }
            }
        });

        renderTable();
        saveToLocal(); // <-- lưu sau khi cập nhật
        document.getElementById('inputText').value = ''; // Xóa ô nhập sau khi xong
    }

    function renderTable() {
        const thead = document.querySelector('#mainTable thead');
        const tbody = document.querySelector('#mainTable tbody');
        let tfoot = document.querySelector('#mainTable tfoot');
        if (!tfoot) {
            tfoot = document.createElement('tfoot');
            document.getElementById('mainTable').appendChild(tfoot);
        }
        // Nếu chưa có dữ liệu, xóa nội dung
        if (!allDishes.size && Object.keys(database).length === 0) {
            thead.innerHTML = '';
            tbody.innerHTML = '';
            tfoot.innerHTML = '';
            return;
        }

        // Sắp xếp danh sách món ăn (A-Z và số)
        let sortedDishes = Array.from(allDishes).sort((a, b) => 
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );

        // Lấy danh sách Khối
        let blocks = Object.keys(database);

        // --- VẼ HEADER NGANG: Khối / Thực đơn ---
        let headerHtml = '<tr><th style="width: 200px; color: Red">Khối / Thực đơn</th>';
        sortedDishes.forEach(dish => {
            headerHtml += `<th>${dish}</th>`;
        });
        headerHtml += '<th class="total-cell">Tổng chung</th></tr>';
        thead.innerHTML = headerHtml;

        // Chuẩn bị mảng tổng theo từng món
        let totalsByDish = new Array(sortedDishes.length).fill(0);
        let grandTotal = 0;

        // --- VẼ BODY: mỗi hàng là một Khối ---
        let bodyHtml = '';
        blocks.forEach(block => {
            let rowHtml = `<tr><td class="menu-name">${block}</td>`;
            let rowTotal = 0;

            sortedDishes.forEach((dish, idx) => {
                let qty = (database[block] && database[block][dish]) ? database[block][dish] : 0;
                rowHtml += `<td>${qty > 0 ? qty : '-'}</td>`;
                rowTotal += qty;
                totalsByDish[idx] += qty;
            });

            rowHtml += `<td class="total-cell">${rowTotal}</td></tr>`;
            bodyHtml += rowHtml;
            grandTotal += rowTotal;
        });

        tbody.innerHTML = bodyHtml;

        // Thêm hàng tổng ở cuối (tfoot)
        let totalRow = '<tr><td class="menu-name total-cell">Tổng cộng</td>';
        totalsByDish.forEach(t => {
            totalRow += `<td class="total-cell">${t > 0 ? t : '-'}</td>`;
        });
        totalRow += `<td class="total-cell">${grandTotal}</td></tr>`;
        tfoot.innerHTML = totalRow;
    }

    function resetData() {
        if(confirm('Xóa toàn bộ dữ liệu bảng?')) {
            database = {};
            allDishes = new Set();
            localStorage.removeItem('setmenu_db');
            localStorage.removeItem('setmenu_dishes');
            renderTable();
        }
    }

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function renderTableToContainer(container) {
        // Sắp xếp danh sách món ăn (A-Z và số)
        let sortedDishes = Array.from(allDishes).sort((a, b) =>
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );
        let blocks = Object.keys(database);

        let table = document.createElement('table');
        table.style.width = '1200px';
        table.style.borderCollapse = 'collapse';
        table.style.background = 'white';
        table.className = 'export-table';

        let thead = document.createElement('thead');
        let headerRow = document.createElement('tr');
        let thBlock = document.createElement('th');
        thBlock.textContent = 'Khối / Thực đơn';
        thBlock.style.width = '200px';
        headerRow.appendChild(thBlock);

        sortedDishes.forEach(dish => {
            let th = document.createElement('th');
            th.textContent = dish;
            headerRow.appendChild(th);
        });
        let thTotal = document.createElement('th');
        thTotal.textContent = 'Tổng chung';
        thTotal.className = 'total-cell';
        headerRow.appendChild(thTotal);
        thead.appendChild(headerRow);
        table.appendChild(thead);

        let tbody = document.createElement('tbody');
        let totalsByDish = new Array(sortedDishes.length).fill(0);
        let grandTotal = 0;

        blocks.forEach(block => {
            let row = document.createElement('tr');
            let tdBlock = document.createElement('td');
            tdBlock.textContent = block;
            tdBlock.className = 'menu-name';
            row.appendChild(tdBlock);

            let rowTotal = 0;
            sortedDishes.forEach((dish, idx) => {
                let qty = (database[block] && database[block][dish]) ? database[block][dish] : 0;
                let td = document.createElement('td');
                td.textContent = qty > 0 ? qty : '-';
                row.appendChild(td);
                rowTotal += qty;
                totalsByDish[idx] += qty;
            });
            let tdTotal = document.createElement('td');
            tdTotal.textContent = rowTotal;
            tdTotal.className = 'total-cell';
            row.appendChild(tdTotal);
            tbody.appendChild(row);
            grandTotal += rowTotal;
        });

        // Tổng cộng
        let totalRow = document.createElement('tr');
        let tdTotalLabel = document.createElement('td');
        tdTotalLabel.textContent = 'Tổng cộng';
        tdTotalLabel.className = 'menu-name total-cell';
        totalRow.appendChild(tdTotalLabel);
        totalsByDish.forEach(t => {
            let td = document.createElement('td');
            td.textContent = t > 0 ? t : '-';
            td.className = 'total-cell';
            totalRow.appendChild(td);
        });
        let tdGrand = document.createElement('td');
        tdGrand.textContent = grandTotal;
        tdGrand.className = 'total-cell';
        totalRow.appendChild(tdGrand);
        tbody.appendChild(totalRow);

        table.appendChild(tbody);
        container.appendChild(table);
    }

    function exportTableAsImage() {
        // Tạo div ẩn ngoài màn hình
        const offscreen = document.createElement('div');
        offscreen.style.position = 'fixed';
        offscreen.style.left = '-9999px';
        offscreen.style.top = '0';
        offscreen.style.width = '1200px';
        offscreen.style.background = 'white';
        offscreen.style.zIndex = '-1';
        offscreen.style.padding = '24px';
        offscreen.style.boxSizing = 'border-box';
        offscreen.className = 'offscreen-export';

        // Copy style cho bảng xuất ảnh
        const style = document.createElement('style');
        style.textContent = `
            .export-table, .export-table th, .export-table td {
                border: 1px solid #eee;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 16px;
            }
            .export-table th {
                background: #34495e;
                color: #fff;
                font-weight: bold;
                padding: 12px 14px;
            }
            .export-table td {
                padding: 12px 14px;
                text-align: center;
            }
            .export-table .menu-name {
                text-align: left;
                font-weight: 600;
                color: #34495e;
                background: #fff;
            }
            .export-table .total-cell {
                background: #fff3cd;
                color: #856404;
                font-weight: bold;
            }
            .export-table tr:nth-child(even) td {
                background: #f8f9fa;
            }
        `;
        offscreen.appendChild(style);

        renderTableToContainer(offscreen);

        document.body.appendChild(offscreen);

        html2canvas(offscreen, {
            backgroundColor: null,
            scale: 2,
            width: 1200,
            windowWidth: 1300
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'bao_cao_suat_an_' + new Date().toLocaleDateString('vi-VN').replace(/\//g,'-') + '.jpeg';
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                document.body.removeChild(link);
                document.body.removeChild(offscreen);
            }, 100);
        }).catch(() => {
            document.body.removeChild(offscreen);
        });
    }

    // Khôi phục dữ liệu khi load trang
    window.addEventListener('DOMContentLoaded', loadFromLocal);

    // thêm biến giữ event beforeinstallprompt
    let deferredInstallPrompt = null;
    const btnInstall = document.getElementById('btnInstall');

    // Bắt event trước khi trình duyệt show install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        // nếu đã cài (cờ lưu), không hiện
        if (!localStorage.getItem('setmenu_installed')) {
            btnInstall.style.display = 'block';
        }
    });

    // Khi người dùng click nút install
    btnInstall && btnInstall.addEventListener('click', async () => {
        if (!deferredInstallPrompt) return;
        deferredInstallPrompt.prompt();
        const choice = await deferredInstallPrompt.userChoice;
        // nếu người dùng đồng ý, lưu flag và ẩn nút
        if (choice && choice.outcome === 'accepted') {
            localStorage.setItem('setmenu_installed', '1');
            btnInstall.style.display = 'none';
        }
        deferredInstallPrompt = null;
    });

    // Khi app được cài (event appinstalled)
    window.addEventListener('appinstalled', (evt) => {
        localStorage.setItem('setmenu_installed', '1');
        btnInstall.style.display = 'none';
    });

    // Đăng ký service worker (nếu hỗ trợ)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
            .then(reg => { /* đăng ký thành công */ })
            .catch(err => { console.warn('SW register failed', err); });
    }

    async function pasteFromClipboard() {
        const textarea = document.getElementById('inputText');
        if (navigator.clipboard && window.isSecureContext) {
            try {
                const text = await navigator.clipboard.readText();
                textarea.value = text;
                textarea.focus();
            } catch (e) {
                alert('Không thể dán từ clipboard. Hãy cấp quyền hoặc thử lại.');
            }
        } else {
            alert('Trình duyệt không hỗ trợ dán nhanh.');
        }
    }
</script>

</body>
</html>