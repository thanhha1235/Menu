<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool B√°o C√°o Su·∫•t ƒÇn Th√¥ng Minh</title>
    <style>
	:root{
		--bg:#f0f2f5;
		--card:#ffffff;
		--muted:#333;
		--accent:#3498db;
		--dark:#34495e;
		--success:#27ae60;
		--danger:#e74c3c;
		--excel:#2980b9;
		--gap:20px;
		--radius:12px;
		--pad:20px;
	}

	body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--bg); padding: clamp(12px,2.5vw,28px); color: var(--muted); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
	.container { max-width: 1200px; margin: 0 auto; background: var(--card); padding: clamp(16px,2.6vw,28px); border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
	h2 { color: var(--dark); text-align: center; margin-bottom: 18px; font-size: clamp(1.1rem,1.6vw,1.6rem); }

	.row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: flex-start; }
	.col-input { flex: 1 1 520px; min-width: 260px; }
	.col-actions { flex: 0 0 220px; display: flex; flex-direction: column; gap: 10px; justify-content: center; align-items: stretch; }

	textarea {
		width: 100%;
		min-height: clamp(140px, 28vh, 320px);
		padding: 14px;
		border: 2px solid #e1e4e8;
		border-radius: 8px;
		font-size: 14px;
		line-height: 1.5;
		resize: vertical;
		transition: border-color 0.2s, box-shadow 0.15s;
		background: #fff;
	}
	textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 4px 18px rgba(52,152,219,0.08); }

	button {
		padding: 12px 14px;
		border: none;
		border-radius: 8px;
		cursor: pointer;
		font-weight: 600;
		font-size: 14px;
		transition: transform 0.08s, opacity 0.15s;
		color: white;
		width: 100%;
		box-shadow: 0 2px 6px rgba(0,0,0,0.04);
	}
	button:active { transform: scale(0.99); }
	.btn-add { background-color: var(--success); }
	.btn-add:hover { filter:brightness(.95); }
	.btn-excel { background-color: var(--excel); }
	.btn-excel:hover { filter:brightness(.95); }
	.btn-reset { background-color: var(--danger); }
	.btn-reset:hover { filter:brightness(.95); }

	/* Table Styles */
	.table-wrapper { overflow-x: auto; margin-top: 22px; border-radius: 8px; border: 1px solid #eee; -webkit-overflow-scrolling: touch; background: white; }
	table { width: 100%; border-collapse: collapse; min-width: 700px; table-layout: auto; }
	th, td { padding: 12px 14px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.95rem; vertical-align: middle; }
	th { background-color: var(--dark); color: white; white-space: nowrap; position: relative; }
	tr:nth-child(even) { background-color: #f8f9fa; }
	tr:hover { background-color: #f1f1f1; }
	.menu-name { text-align: left; font-weight: 600; color: var(--dark); white-space: normal; }
	.total-cell { background-color: #fff3cd; color: #856404; font-weight: bold; }

	.tips { background: #e8f4fd; border-left: 4px solid var(--accent); padding: 14px; margin-bottom: 16px; border-radius: 6px; font-size: 0.95em; }
	.highlight { color: var(--danger); font-weight: bold; }

	/* Responsive tweaks */
	@media (max-width: 900px) {
		.col-actions { flex-direction: row; gap: 10px; flex-wrap: wrap; align-items: center; }
		.col-actions button { flex: 1 1 0; }
		.table-wrapper { margin-top: 18px; }
		th, td { padding: 10px 8px; font-size: 0.92rem; }
	}

	@media (max-width: 600px) {
		.row { flex-direction: column; }
		.col-input, .col-actions { min-width: 100%; flex: 1 1 100%; }
		.col-actions { flex-direction: row; gap: 8px; justify-content: space-between; }
		.col-actions button { padding: 10px 8px; font-size: 13px; }
		/* Allow table to scroll horizontally but make first column sticky for readability */
		table { min-width: 600px; }
		th:first-child, td:first-child { position: sticky; left: 0; z-index: 3; background: linear-gradient(180deg,#34495e,#34495e); color: white; }
		td:first-child { background: var(--card); color: var(--dark); z-index:2; }
		th { white-space: normal; font-size: 0.95rem; }
		.menu-name { font-size: 0.95rem; }
		.tips { font-size: 0.9rem; padding: 10px; }
	}

	@media (max-width: 380px) {
		button { font-size: 13px; padding: 10px; }
		.container { padding: 12px; }
	}
	</style>
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#34495e">
</head>
<body>

<div class="container">
    <h2>C√¥ng C·ª• T·ªïng H·ª£p Su·∫•t ƒÇn (B·∫£n Linh Ho·∫°t)</h2>

    <div class="tips">
        <strong>M·∫πo nh·∫≠p li·ªáu nhanh:</strong><br>
        - D√≤ng n√†o <strong>kh√¥ng c√≥ s·ªë</strong> s·∫Ω ƒë∆∞·ª£c hi·ªÉu l√† t√™n <strong>Kh·ªëi</strong> <br>
        - D√≤ng n√†o <strong>c√≥ s·ªë ·ªü cu·ªëi</strong> s·∫Ω ƒë∆∞·ª£c hi·ªÉu l√† <strong>Th·ª±c ƒë∆°n + S·ªë l∆∞·ª£ng</strong> 
    </div>

    <div class="row">
        <div class="col-input">
            <textarea id="inputText" placeholder="D√°n b√°o c√°o v√†o ƒë√¢y. V√≠ d·ª•:

VPNH
TD1 8
TD2 4

Kh·ªëi KHCN
Th·ª±c ƒë∆°n 1: 5
Th·ª±c ƒë∆°n 3 - 2 su·∫•t"></textarea>
        </div>
        <div class="col-actions">
            <button class="btn-add" onclick="processData()">‚¨á C·∫≠p nh·∫≠t v√†o b·∫£ng</button>
            <button class="btn-excel" onclick="exportTableAsImage()">üñºÔ∏è L∆∞u ·∫£nh b·∫£ng</button>
            <button class="btn-reset" onclick="resetData()">‚Üª X√≥a l√†m l·∫°i</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Th√™m n√∫t c√†i ƒë·∫∑t (m·∫∑c ƒë·ªãnh ·∫©n) -->
	<button id="btnInstall" class="btn-add" style="display:none; margin-top:12px;">‚ûï Th√™m v√†o M√†n h√¨nh ch√≠nh</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
	let database = {}; // C·∫•u tr√∫c: { "T√™n Kh·ªëi": { "T√™n M√≥n": S·ªë l∆∞·ª£ng } }
	let allDishes = new Set(); // L∆∞u danh s√°ch c√°c m√≥n ƒÉn duy nh·∫•t

	function saveToLocal() {
		try {
			localStorage.setItem('setmenu_db', JSON.stringify(database));
			localStorage.setItem('setmenu_dishes', JSON.stringify(Array.from(allDishes)));
		} catch (e) {
			console.warn('L∆∞u localStorage th·∫•t b·∫°i', e);
		}
	}

	function loadFromLocal() {
		try {
			const db = localStorage.getItem('setmenu_db');
			const dishes = localStorage.getItem('setmenu_dishes');
			if (db) database = JSON.parse(db);
			if (dishes) allDishes = new Set(JSON.parse(dishes));
			renderTable();
		} catch (e) {
			console.warn('Kh√¥i ph·ª•c localStorage th·∫•t b·∫°i', e);
		}
	}

	function processData() {
		const text = document.getElementById('inputText').value;
		const lines = text.split('\n');
		let currentBlock = "Ch∆∞a x√°c ƒë·ªãnh"; // T√™n kh·ªëi m·∫∑c ƒë·ªãnh n·∫øu d√≤ng ƒë·∫ßu ti√™n l√† m√≥n ƒÉn

		lines.forEach(line => {
			line = line.trim();
			if (!line) return; // B·ªè qua d√≤ng tr·ªëng

			// LOGIC NH·∫¨N DI·ªÜN TH√îNG MINH
			// Regex m·ªõi: nh·∫≠n t√™n m√≥n v√† s·ªë l∆∞·ª£ng ·ªü cu·ªëi, c√≥ th·ªÉ c√≥ d·∫•u :, -, ho·∫∑c ch·ªØ su·∫•t/pax/s ph√≠a sau
			let match = line.match(/^(.*?)(?:[\s:\-=]+)?(\d+)\s*(?:su·∫•t|suat|pax|s)?\.?$/i);

			if (match) {
				// === ƒê√ÇY L√Ä D√íNG TH·ª∞C ƒê∆†N ===
				let dishName = match[1].trim();
				let quantity = parseInt(match[2]);

				// L√†m s·∫°ch t√™n m√≥n (B·ªè d·∫•u : ho·∫∑c - th·ª´a ·ªü cu·ªëi t√™n m√≥n n·∫øu regex ch∆∞a b·∫Øt h·∫øt)
				dishName = dishName.replace(/[:\-=]+$/, '').trim();

				// Chu·∫©n h√≥a t√™n m√≥n (Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu ƒë·ªÉ ƒë·∫πp b·∫£ng)
				if(dishName.toLowerCase().startsWith('th·ª±c ƒë∆°n')) dishName = capitalizeFirstLetter(dishName);
				if(dishName.toLowerCase().startsWith('td')) dishName = dishName.replace(/td/i, 'Th·ª±c ƒë∆°n');

				if (dishName && quantity > 0) {
					if (!database[currentBlock]) database[currentBlock] = {};
					// Ghi ƒë√® s·ªë l∆∞·ª£ng thay v√¨ c·ªông d·ªìn
					database[currentBlock][dishName] = quantity;
					allDishes.add(dishName);
				}

			} else {
				let blockName = line.replace(/^(Kh·ªëi|Khoi|Ph√≤ng|Ban|Team)\s*[:\.]?/i, '').replace(/[:\.]+$/, '').trim();
				if (blockName.length > 0) {
					currentBlock = blockName;
					// Kh·ªüi t·∫°o object cho kh·ªëi n√†y ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ hi·ªán l√™n c·ªôt ngay c·∫£ khi ch∆∞a c√≥ m√≥n
					if (!database[currentBlock]) database[currentBlock] = {};
				}
			}
		});

		renderTable();
		saveToLocal(); // <-- l∆∞u sau khi c·∫≠p nh·∫≠t
		document.getElementById('inputText').value = ''; // X√≥a √¥ nh·∫≠p sau khi xong
		document.getElementById('inputText').focus();
	}

	function renderTable() {
		const thead = document.querySelector('#mainTable thead');
		const tbody = document.querySelector('#mainTable tbody');
		
		// N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, x√≥a n·ªôi dung
		if (!allDishes.size && Object.keys(database).length === 0) {
			thead.innerHTML = '';
			tbody.innerHTML = '';
			return;
		}

		// S·∫Øp x·∫øp danh s√°ch m√≥n ƒÉn (A-Z v√† s·ªë)
		let sortedDishes = Array.from(allDishes).sort((a, b) => 
			a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
		);

		// L·∫•y danh s√°ch Kh·ªëi
		let blocks = Object.keys(database);

		// --- V·∫º HEADER NGANG: Kh·ªëi / Th·ª±c ƒë∆°n ---
		let headerHtml = '<tr><th style="width: 200px;">Kh·ªëi / Th·ª±c ƒë∆°n</th>';
		sortedDishes.forEach(dish => {
			headerHtml += `<th>${dish}</th>`;
		});
		headerHtml += '<th class="total-cell">T·ªïng</th></tr>';
		thead.innerHTML = headerHtml;

		// Chu·∫©n b·ªã m·∫£ng t·ªïng theo t·ª´ng m√≥n
		let totalsByDish = new Array(sortedDishes.length).fill(0);
		let grandTotal = 0;

		// --- V·∫º BODY: m·ªói h√†ng l√† m·ªôt Kh·ªëi ---
		let bodyHtml = '';
		blocks.forEach(block => {
			let rowHtml = `<tr><td class="menu-name">${block}</td>`;
			let rowTotal = 0;

			sortedDishes.forEach((dish, idx) => {
				let qty = (database[block] && database[block][dish]) ? database[block][dish] : 0;
				rowHtml += `<td>${qty > 0 ? qty : '-'}</td>`;
				rowTotal += qty;
				totalsByDish[idx] += qty;
			});

			rowHtml += `<td class="total-cell">${rowTotal}</td></tr>`;
			bodyHtml += rowHtml;
			grandTotal += rowTotal;
		});

		// Th√™m h√†ng t·ªïng ·ªü cu·ªëi
		let totalRow = '<tr><td class="menu-name total-cell">T·ªïng c·ªông</td>';
		totalsByDish.forEach(t => {
			totalRow += `<td class="total-cell">${t > 0 ? t : '-'}</td>`;
		});
		totalRow += `<td class="total-cell">${grandTotal}</td></tr>`;

		tbody.innerHTML = bodyHtml + totalRow;
	}

	function resetData() {
		if(confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu b·∫£ng?')) {
			database = {};
			allDishes = new Set();
			localStorage.removeItem('setmenu_db');
			localStorage.removeItem('setmenu_dishes');
			renderTable();
		}
	}

	function capitalizeFirstLetter(string) {
		return string.charAt(0).toUpperCase() + string.slice(1);
	}

	function exportTableAsImage() {
		const tableWrapper = document.querySelector('.table-wrapper');
		if (!tableWrapper) return;
		// Th√™m hi·ªáu ·ª©ng loading n·∫øu mu·ªën
		html2canvas(tableWrapper, {
			backgroundColor: null, // gi·ªØ n·ªÅn trong su·ªët
			scale: window.devicePixelRatio || 2
		}).then(canvas => {
			const link = document.createElement('a');
			link.download = 'bao_cao_suat_an_' + new Date().toLocaleDateString('vi-VN').replace(/\//g,'-') + '.png';
			link.href = canvas.toDataURL('image/png');
			document.body.appendChild(link);
			link.click();
			setTimeout(() => document.body.removeChild(link), 100);
		});
	}

	// Kh√¥i ph·ª•c d·ªØ li·ªáu khi load trang
	window.addEventListener('DOMContentLoaded', loadFromLocal);

	// th√™m bi·∫øn gi·ªØ event beforeinstallprompt
	let deferredInstallPrompt = null;
	const btnInstall = document.getElementById('btnInstall');

	// B·∫Øt event tr∆∞·ªõc khi tr√¨nh duy·ªát show install prompt
	window.addEventListener('beforeinstallprompt', (e) => {
		e.preventDefault();
		deferredInstallPrompt = e;
		// n·∫øu ƒë√£ c√†i (c·ªù l∆∞u), kh√¥ng hi·ªán
		if (!localStorage.getItem('setmenu_installed')) {
			btnInstall.style.display = 'block';
		}
	});

	// Khi ng∆∞·ªùi d√πng click n√∫t install
	btnInstall && btnInstall.addEventListener('click', async () => {
		if (!deferredInstallPrompt) return;
		deferredInstallPrompt.prompt();
		const choice = await deferredInstallPrompt.userChoice;
		// n·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω, l∆∞u flag v√† ·∫©n n√∫t
		if (choice && choice.outcome === 'accepted') {
			localStorage.setItem('setmenu_installed', '1');
			btnInstall.style.display = 'none';
		}
		deferredInstallPrompt = null;
	});

	// Khi app ƒë∆∞·ª£c c√†i (event appinstalled)
	window.addEventListener('appinstalled', (evt) => {
		localStorage.setItem('setmenu_installed', '1');
		btnInstall.style.display = 'none';
	});

	// ƒêƒÉng k√Ω service worker (n·∫øu h·ªó tr·ª£)
	if ('serviceWorker' in navigator) {
		navigator.serviceWorker.register('service-worker.js')
			.then(reg => { /* ƒëƒÉng k√Ω th√†nh c√¥ng */ })
			.catch(err => { console.warn('SW register failed', err); });
	}
</script>

</body>
</html>